<!-- 
    adapted from various bits and pieces across the web: 
        - https://codeberg.org/gedankenstuecke/pages-source/src/commit/9d068955e253ce59f3359c55311ca9e463ca419a/_includes/fedi_comments.html
        - https://codeberg.org/jwildeboer/jwildeboersource, under MIT license 
        - https://codeberg.org/ashwinvis/m.css (under MIT license)
        - first seen at https://fossacademic.tech/2021/12/16/CommentsTest.html (under CC BY-NC)
--> 
<section class="page__comments post-footer">
  <div class="post-footer">
  <b id="comment_title" class="page__comments-title">Comments</b>
  <p class="post-meta">
  You can use your <a href="https://joinmastodon.org">Mastodon</a> or other <em>ActivityPub</em>-based <em>Fediverse</em>-account to comment on this article by <a class="link" href="https://{{ page.comments.host }}/@{{ page.comments.username }}/{{ page.comments.id }}">leaving a publicly visible reply to this associated post</a>. Content warnings are supported. You can also delete your comments at any time by deleting your post on the Fediverse.
  </p>
  <p id="fedicomments-list">
    <button id="fedicomments-load" class="btn btn--twitter">Load comments from Fediverse</button>
  </p>
  <noscript><p>You have to allow JavaScript to view the comments.</p></noscript>
  <script src="/assets/js/purify.min.js"></script>
  <script type="text/javascript">
// Requires:
// import { DOMPurify } from 'purify.min.js'
// fediHost and fediId JS variables defined in an inline script

function escapeHtml (unsafe) {
  return unsafe
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;')
}

const loadComment = document.getElementById('fedicomments-load')
const fediCommentsList = document.getElementById('fedicomments-list')

loadComment.addEventListener('click', function () {
  loadComment.innerHTML = 'Loading'  
      fetch('https://{{ page.comments.host }}/api/v1/statuses/{{ page.comments.id }}/context')
        .then(function (response) {
      return response.json()
    })
    .then(function (data) {
      if (data.descendants &&
         Array.isArray(data.descendants) &&
        data.descendants.length > 0) {
        fediCommentsList.innerHTML = ''
        data.descendants.forEach(function (reply) {
          reply.account.display_name = escapeHtml(reply.account.display_name)
          reply.account.emojis.forEach(emoji => {
            reply.account.display_name = reply.account.display_name.replace(`:${emoji.shortcode}:`,
                `<img src="${escapeHtml(emoji.static_url)}" alt="Emoji ${emoji.shortcode}" height="20" width="20" />`)
          })
          let fediCommentContent
          if (reply.spoiler_text === '') {
            fediCommentContent = reply.content
          } else {
            fediCommentContent =
                  `<details><summary><span id="fedicomment-cw">‚ö†Ô∏è CW <em>(click to open)</em>: ${escapeHtml(reply.spoiler_text)} </span></summary>
                    ${reply.content}
                 </details>`
          }
          let commentClass  
          if (reply.in_reply_to_id !== "{{ page.comments.id }}"){
              commentClass = "author comment reply"
          } else {
              commentClass = "author comment"
          }
          const mastodonComment = 
                `<article id="comment-${reply.id }" div class="${commentClass}">
                       <div class="author__left">
                         <img class="author__picture" src="${escapeHtml(reply.account.avatar_static)}" alt="Avatar of ${reply.account.display_name}">
                       </div>
                       <div class="author__right" style="width:89%">
                        <h4 class="author__name" style="width:89%">
                          <a rel="external nofollow" href="${reply.uri}" rel="nofollow">
                            ${reply.account.display_name} @ ${reply.created_at.substr(0, 10)}
                          </a>
                        </h4>
                        <div class="post-meta" style="width:89%">${fediCommentContent}</div>
                        </div>
                        <div class="status" style="font-size: 0.9rem;">
                          <i class="fa fa-reply fa-fw grey"></i>&nbsp;${reply.replies_count}&nbsp;|&nbsp; 
                          <i class="fa fa-retweet fa-fw grey"></i>&nbsp;${reply.reblogs_count}&nbsp;|&nbsp;
                          <i class="fa fa-star fa-fw grey"></i>&nbsp;${reply.favourites_count}
                        </div> 
                       </div>
                    </article>`;

          fediCommentsList.appendChild(DOMPurify.sanitize(mastodonComment, { RETURN_DOM_FRAGMENT: true }))
        })
      } else {
        fediCommentsList.innerHTML = '<p>No comments found üòï</p>'
      }
    })
    .then(() => { loadComment.innerHTML = 'Reload comments' })
})
</script>
  </div>
</section>
